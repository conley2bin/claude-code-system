---
name: audit-compliance
description: "Audit project code compliance with system-level CLAUDE.md principles with optional baseline tracking and report generation"
allowed-tools: Read, Grep, Glob, Edit, Write, Bash, mcp__serena__*, mcp__sequential-thinking__*
argument-hint: [scope] | --focus <domain> | --severity <level> | --interactive | --baseline | --report | --compare
category: workflow
complexity: advanced
mcp-servers: [serena, sequential]
personas: [architect, quality]
---

# /audit-compliance - Code Compliance Audit

## Triggers
- Code compliance verification against CLAUDE.md development principles
- Architecture and code quality assessment based on established standards
- Project-wide principle adherence validation and technical debt identification
- Periodic compliance audits for maintaining coding standards

## Usage
```
/audit-compliance [scope] [--focus <domain>] [--severity critical|warning|all] [--interactive] [--baseline] [--report] [--compare]
```

### Execution Modes

#### **Default: Auto-Fix** `/audit-compliance`
- Analyzes code against all CLAUDE.md principles
- **Automatically fixes all safe violations**
- Still requires Claude Code Edit permission per file
- Fast and efficient for trusted fixes
- Shows terminal summary only (no files generated by default)

#### **Interactive Mode: `--interactive`**
- Analyzes code and finds all violations
- **Shows each violation with before/after diff**
- Asks: "Fix this? (y/n/skip-all)" for each fixable issue
- Applies only user-approved fixes
- Use when you want to review each change carefully

**Example Interactive Flow:**
```
[1/12] src/config/manager.ts:15
Principle: "Avoid Abbreviations" (from CLAUDE.md)

Before:
  const cfg = getConfig()

After:
  const configuration = getConfig()

Fix this? (y/n/skip-all): y
âœ“ Fixed

[2/12] src/utils/context.ts:23
...
```

## Behavioral Flow
1. **Parse CLAUDE.md**: Read ~/.claude/CLAUDE.md and dynamically extract all principles, patterns, and rules
   - Identify "Required Patterns" (correct examples)
   - Identify "Forbidden Patterns" (anti-patterns to avoid)
   - Extract principle names and descriptions from section headers
2. **Build Checkers**: Dynamically construct validation rules based on parsed principles
   - Create pattern matchers for each required/forbidden pattern
   - Build symbol analyzers for structural principles
   - Configure severity levels based on principle importance
3. **Analyze**: Scan project codebase using Serena MCP symbolic analysis
   - Apply all dynamically-built checkers against codebase
   - Collect violations with file locations and code context
4. **Output**: Display terminal summary with violation details
   - Group violations by CLAUDE.md sections (Core Principles, Architecture, etc.)
   - Quote original principle text from CLAUDE.md for each violation
   - Provide code examples showing violation vs correct pattern
5. **Action**: Auto-fix violations, optionally save baseline or generate report (requires explicit flags)

Key behaviors:
- **Dynamic Rule Extraction**: CLAUDE.md is the Single Source of Truth - all rules derived from it
- **Zero Hardcoded Rules**: No predefined categories - everything parsed from CLAUDE.md dynamically
- **Automatic Updates**: CLAUDE.md changes automatically reflect in next audit run
- Multi-persona coordination (architect for architecture, quality for code patterns)
- Serena MCP integration for token-efficient symbolic code analysis
- Sequential MCP for systematic principle-by-principle validation
- Baseline tracking for measuring compliance improvement over time

## MCP Integration
- **Serena MCP**: Mandatory for symbolic code analysis and pattern detection
  - `find_symbol`: Locate symbols for naming and structure validation
  - `search_for_pattern`: Pattern matching for principle violations
  - `find_referencing_symbols`: Dependency and usage analysis
  - `get_symbols_overview`: High-level code structure understanding
- **Sequential MCP**: Auto-activated for complex multi-principle analysis and systematic validation

## Tool Coordination
- **Read**: Load ~/.claude/CLAUDE.md and parse principles for validation rules
- **Serena Tools**: Symbolic code analysis for token-efficient compliance checking
- **Grep/Glob**: Pattern-based violation detection across codebase
- **Write**: Generate baseline (--baseline) or report (--report) files only when explicitly requested
- **Edit**: Auto-fix violations (default behavior)
- **TodoWrite**: Track multi-file compliance improvements

## Key Patterns
- **Dynamic Principle Parsing**: Read CLAUDE.md â†’ Parse structure â†’ Extract all principles dynamically
- **Rule Generation**: Principle text â†’ Identify patterns â†’ Build checkers â†’ No hardcoded rules
- **Violation Detection**: Apply dynamic checkers â†’ Pattern matching â†’ Context extraction â†’ Severity assignment
- **Report Generation**: Violations â†’ Group by CLAUDE.md sections â†’ Quote original principles â†’ Recommendations

## Examples

**Default: Auto-Fix Everything**
```bash
/audit-compliance
```
Automatically fixes all safe violations. Shows summary:
- Fixed 12 naming violations
- Fixed 8 dead code issues
- 5 error handling issues require manual review
- Compliance Score: 78 â†’ 89 (+11)

**Interactive: Review Each Change**
```bash
/audit-compliance --interactive
```
Shows each violation with before/after diff. User approves/rejects each fix:
```
[1/12] src/config/manager.ts:15
Principle: "Avoid Abbreviations"

Before:  const cfg = getConfig()
After:   const configuration = getConfig()

Fix this? (y/n/skip-all): y
Fixed
```

**Focus on Specific Domain**
```bash
/audit-compliance --focus naming                    # Auto-fix naming only
/audit-compliance --focus naming --interactive      # Interactive naming fixes
```

**Specific Directory or File**
```bash
/audit-compliance src/                              # Directory scope
/audit-compliance src/config/manager.ts --interactive  # Single file
```

**Critical Issues Only**
```bash
/audit-compliance --severity critical               # Auto-fix critical only
/audit-compliance --severity critical --interactive # Interactive critical
```

**Baseline and Progress Tracking**
```bash
/audit-compliance --baseline    # Save baseline to .claude/audit-baseline.json
/audit-compliance --compare     # Compare with baseline (requires existing baseline)
```

**Report Generation**
```bash
/audit-compliance --report              # Generate .claude/compliance-report.md
/audit-compliance --baseline --report   # Combine: baseline + report
```

**Incremental Audit**
```bash
/audit-compliance --since HEAD~5   # Only files changed in last 5 commits
```

## How Principles Are Detected (Dynamic Extraction)

The command **does not have hardcoded rules**. Instead, it dynamically extracts principles from CLAUDE.md:

### Parsing Strategy
1. **Section Headers**: Extract from ## and ### markdown headers
   - Example: "### Fail-Fast Principle" â†’ Create "Fail-Fast" checker

2. **Required Patterns**: Code blocks marked with âœ… or "CORRECT" comments
   ```
   // CORRECT: Access from parent
   getSharedResource() { return this.parent.sharedResource }
   ```
   â†’ Build checker to encourage this pattern

3. **Forbidden Patterns**: Code blocks marked with âŒ or "WRONG" comments
   ```
   // WRONG: Silent failure
   if (x == null) { x = defaultValue }
   ```
   â†’ Build checker to detect and flag this anti-pattern

4. **Severity Keywords**: Derive severity from principle language
   - "MUST", "NEVER", "Forbidden" â†’ Critical
   - "SHOULD", "Avoid", "Recommended" â†’ Warning
   - "Consider", "Prefer" â†’ Info

5. **Principle Descriptions**: Extract "Core Concept" text for violation reports
   - Used to explain WHY code violates the principle

### Example: How Fail-Fast Gets Parsed

From CLAUDE.md:
```markdown
### Fail-Fast Principle
**Core Concept**: Expose errors immediately...

**Required Pattern**:
if (dependency == null) {
    throw Error("Required dependency is null")
}

**Forbidden Patterns**:
if (x == null) { x = defaultValue }  // Hides initialization issues
```

Becomes:
- **Checker Name**: "Fail-Fast Principle"
- **Severity**: Critical (contains "must", "forbidden")
- **Pattern Matcher**: Detect `if (...== null) { ... = ...}` patterns
- **Violation Message**: Quote "Core Concept" text
- **Fix Suggestion**: Show Required Pattern from CLAUDE.md

## Report Format (Generated with --report flag)

When using `--report`, a markdown report is **dynamically organized** by CLAUDE.md structure. Example format:

```markdown
# Code Compliance Audit Report
Generated: 2025-11-05 16:30:00
Scope: Full project
Based on: ~/.claude/CLAUDE.md (SHA: abc123...)

## Summary
- **Compliance Score**: 78/100 (Good)
- **Total Issues**: 42 (across 15 principles from CLAUDE.md)
- ðŸ”´ Critical: 5 (Must fix)
- ðŸŸ¡ Warning: 28 (Should fix)
- ðŸ”µ Info: 9 (Consider)

## Violations by CLAUDE.md Section

### Core Principles â†’ Fail-Fast Principle (5 violations)

#### ðŸ”´ Silent Failure Detected
**From CLAUDE.md**:
> "Expose errors immediately, fail at the problem source rather than hiding or delaying errors."

**Forbidden Pattern** (from CLAUDE.md):
```
// WRONG: Silent failure
if (x == null) { x = defaultValue }
```

**Your Code** (`src/init.ts:67`):
```typescript
if (dependency == null) {
    dependency = createDefault()  // âŒ Violates Fail-Fast
}
```

**Required Pattern** (from CLAUDE.md):
```
// CORRECT
if (dependency == null) {
    throw Error("Required dependency is null - initialization failed")
}
```

**Quick Fix Available**: No (requires manual review)

---

### Architecture Patterns â†’ Naming Principles (12 violations)

#### ðŸŸ¡ Cryptic Abbreviation
**From CLAUDE.md**:
> "Avoid abbreviations like cfg, ctx, usr, mgr, svc. Use configuration, context, user, manager, service."

**Your Code**:
- `src/config/manager.ts:15` - Variable `cfg`
- `src/utils/context.ts:23` - Class `UsrMgr`

**Quick Fix**: `/audit-compliance --fix --focus naming`

---

## Recommendations (Derived from CLAUDE.md priorities)

1. **Priority 1**: Fix 5 critical Fail-Fast violations
2. **Priority 2**: Remove 15 Dead Code instances
3. **Priority 3**: Refactor 12 Naming violations

## Next Steps

```bash
/audit-compliance --fix --focus naming  # Auto-fix simple issues
/audit-compliance --baseline            # Track improvement
/audit-compliance --compare             # See progress
```
```

**Note**: Reports are only generated when using `--report` flag. The report structure mirrors CLAUDE.md's organization. As you update CLAUDE.md, reports automatically adapt.

## Permission Model

### Claude Code Permission Flow

Both modes require Claude Code Edit permission when modifying files:

1. **Default (Auto-Fix)**: `/audit-compliance`
   - Agent applies all safe fixes automatically
   - Claude Code asks for Edit permission per file
   - User can approve/reject at file level

2. **Interactive Mode (`--interactive`)**: `/audit-compliance --interactive`
   - Agent shows each violation with before/after diff
   - User decides: "Fix this? (y/n/skip-all)"
   - After user approves, Claude Code asks for Edit permission per file
   - **Double confirmation**: User approval + Claude Code permission

### What Can Be Auto-Fixed

Auto-fixable:
- Naming violations: cfg â†’ configuration, usr â†’ user
- Unused imports: Remove unused import statements
- Dead code: Remove unreferenced functions/variables (with confirmation)

Requires manual review:
- Architecture issues: Circular dependencies
- Error handling: Silent failures (logic changes)
- YAGNI violations: Premature abstractions (judgment required)

## Boundaries

**Will:**
- Audit code compliance against system-level CLAUDE.md principles systematically
- **Default to auto-fixing** for immediate value and efficiency
- Show before/after diffs in interactive mode for careful review
- Display terminal summary with violation details (always)
- Generate baseline file only when `--baseline` flag is used
- Generate detailed markdown report only when `--report` flag is used
- Auto-fix simple violations (naming, imports, dead code) safely
- Always respect Claude Code's permission system for file modifications

**Will Not:**
- Generate files by default (baseline and reports require explicit flags)
- Modify code without Claude Code Edit permission (always required)
- Override project-specific conventions that differ from CLAUDE.md
- Audit external dependencies or third-party library code
- Perform runtime analysis or execute code for validation
- Apply risky fixes that could break functionality (architecture, logic changes)
